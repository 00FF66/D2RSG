# Генератор случайных сценариев Disciples 2

## Введение
Генератор сценариев предназначен для создания пользовательских сценариев (карт) со случайным наполнением по шаблонам. Шаблоны представляют собой обычные текстовые файлы на языке Lua.
Задача шаблона - описать содержимое генерируемой карты и задать дефолтные настройки для игрока. Ключевым фактором генерации является создание зон соединенных правильным образом, а также заданного числа объектов, отрядов и наград внутри них максимально близко к указанной ценности. Шаблоны определяют что игрок может ожидать от сценария, какой контент будет присутствовать, при этом никаких гарантий о расположении контента нет. Например: если в зоне указаны 2 лавки торговца и 1 руины значит что они встретятся во время игры, но не обязательно в удобном для игрока месте.

---

## Формат файла шаблона
Шаблоном считается любой корректный файл на языке Lua в котором присутствует таблица `template` с параметрами для игрока, а также полем-функцией `getContents`, которая принимает список рас и размер сценария. Функция `getContents` должна вернуть таблицу с содержимым шаблона, его контентом. Поле `zones` в возвращаемой таблице содержит список зон и их объектов, а поле `connections` определяет связи (проходы) между зонами и опциональную охрану.

### Параметры видимые игроку
Для удобства игрока шаблон определяет несколько параметров которые могут быть изменены пользователем по своему желанию перед генерацией сценария. Такие параметры как `name` и `description` не изменяемы и служат лишь для описания шаблона, а также подсказок игроку о возможном содержимом.
###### Параметры шаблона:
- `name` - название шаблона
- `description` - описание шаблона
- `minSize` - минимальный размер сценария какой может быть создан этим шаблоном. 48 по умолчанию, максимум 144
- `maxSize` - максимальный размер сценария какой может быть создан этим шаблоном. 48 по умолчанию, максимум 144
- `maxPlayers` - количество игроков (рас) в сценарии. 1 по умолчанию, максимум 4
- `startingGold` - количество бонусного золота для каждого игрока. 0 по умолчанию, максимум 9999
- `roads` - процент тайлов проходов которые станут дорогами дающими бонус передвижения. Диапазон `[0 : 100]`, 100 по умолчанию
- `forest` - процент неиспользованных тайлов которые станут лесом. Диапазон `[0 : 100]`, 0 по умолчанию

### Описание содержимого
Для удобства игроков и авторов шаблонов содержимое шаблона может зависеть от настроек игрока. Основными параметрами являются список рас и размер сценария.
Список рас позволит контролировать субрасы отрядов, награды и тип рудников, а размер сценария даст возможность масштабировать количество объектов и отрядов.
Таким образом одним шаблоном можно описать правила генерации чтобы сценарии были играбельны как на размере 48, так и 144.

### Пример
Ниже показан пример простейшего шаблона который создаст пустой сценарий с одной зоной, занимающей всю карту, а также одним игроком. Раса игрока зависит от выбора пользователя.
Формат описания содержимого, зон, соединений и объектов подробно рассматривается в следующей секции.
```lua
template = {
	name = 'Template name',
	description = 'Template description',
	minSize = 48,
	maxSize = 72,
	maxPlayers = 1,
	startingGold = 250,
	roads = 65,
	forest = 45,

	getContents = function(races, scenarioSize)
		return {
			zones = {
				{
					id = 0,
					type = Zone.PlayerStart,
					race = races[1],
					size = 25,
				}
			},
			
			connections = {},
		}
	end,
}
```

---

## Ключевые понятия шаблонов сценариев
Зоны, их содержимое, а также соединения между зонами описываются с помощью Lua таблиц.
Простейшая таблица в языке Lua выглядит следующим образом:
```lua
{ }
```
Таблицы могут быть пустыми, либо содержать именованые поля, не именованые поля и другие таблицы:
```lua
-- Пустая таблица
{ }
-- Таблица с именоваными полями
{ min = 0, max = 100 }
-- Таблица с полями без имен, используются индексы (начиная с 1)
{ [1] = 1, [2] = 100 }
-- Таблица с 2 вложенными таблицами
{ { min = 0, max = 100 }, { min = 10, max = 50 } }
```
Для удобства чтения таблицы могут быть сохранены в переменные, тем самым получая имя:
```lua
local emptyTable = {}
```
Вложенность таблиц и их полей важна, а порядок задания полей не играет роли.
Таким образом приведенный выше пример шаблона содержит таблицу `template` с полями `name`, `description`, `roads`, `forest` и другими.
Также, поле `getContents` в таблице `template` указывает на функцию которая возвращает безымянную таблицу содержащую 2 именованых поля `zones` и `connections`, которые в свою очередь также являются таблицами.
Для удобства чтения этот блок кода можно было записать иначе:
```lua
getContents = function(races, scenarioSize)
    local zone = { id = 0, type = Zone.PlayerStart, race = races[1], size = 25 }
    local scenarioZones = { zone }
    local zoneConnections = {}
    
    local contents = { zones = scenarioZones, connections = zoneConnections }
    return contents
end,
```
В случае с описанием содержимого шаблона генератор понимает и ожидает некоторые заранее определенные таблицы и данные. Поля внутри таких таблиц зависят от того что описывает таблица, другими словами её типа. Ниже будут подробно рассмотрены все существующие типы таблиц, их назначение и поля.

### Типы данных

---

#### Расы (Race)
Расы которые могут появиться в списке рас функции `getContents`:
- `Race.Human` - Защитники Империи
- `Race.Undead` - Орды нежити
- `Race.Heretic` - Легионы проклатых
- `Race.Dwarf` - Горные кланы
- `Race.Elf` - Альянс эльфов

---

#### Субрасы (Subrace)
Субрасы известные генератору:
- `Subrace.Human` - Защитники Империи
- `Subrace.Undead` - Орды нежити
- `Subrace.Heretic` - Легионы проклятых
- `Subrace.Dwarf` - Горные кланы
- `Subrace.Elf` - Альянс эльфов
- `Subrace.Neutral` - Нейтралы
- `Subrace.NeutralHuman` - Нейтральные люди
- `Subrace.NeutralElf` - Нейтральные эльфы
- `Subrace.NeutralGreenSkin` - Зеленокожие
- `Subrace.NeutralDragon` - Драконы
- `Subrace.NeutralMarsh` - Жители болот
- `Subrace.NeutralWater` - Водные обитатели
- `Subrace.NeutralBarbarian` - Варвары
- `Subrace.NeutralWolf` - Животные
- `Subrace.Custom` - Своя субраса

---

#### Типы предметов (Item)
Типы предметов известные генератору:
- `Item.Armor` - Артефакты (не влияющие на урон)
- `Item.Jewel` - Реликвии
- `Item.Weapon` - Артефакты (влияющие на урон)
- `Item.Banner` - Знамена
- `Item.PotionBoost` - Зелья бафов
- `Item.PotionHeal` - Зелья лечения
- `Item.PotionRevive` - Зелья воскрешения
- `Item.PotionPermanent` - Зелья дающие постоянный эффект
- `Item.Scroll` - Свитки
- `Item.Wand` - Посохи
- `Item.Valuable` - Драгоценности
- `Item.Orb` - Сферы
- `Item.Talisman` - Талисманы
- `Item.TravelItem` - Походное снаряжение
- `Item.Special` - Особые

---

#### Типы заклинаний (Spell)
Типы заклинаний известные генератору:
- `Spell.Attack` - Наносящие урон, например 'Армагеддон'
- `Spell.Lower` - Снижающие показатели (дебафы), например 'Гниение'
- `Spell.Heal` - Лечащие заклинания, например 'Исцеление'
- `Spell.Boost` - Увеличивающие показатели (бафы), например 'Гимн Кланов'
- `Spell.Summon` - Призыв, например 'Вызов Белиарха'
- `Spell.Fog` - Наложение тумана войны, например 'Сумерки'
- `Spell.Unfog` - Открытие тумана войны, например 'Свет дня'
- `Spell.RestoreMove` - Восстановление очков движения, например 'Подвижность'
- `Spell.Invisibility` - Невидимость, например 'Сокрытие'
- `Spell.RemoveRod` - Удаление жезлов, например 'Водосточный колодец'
- `Spell.ChangeTerrain` - Смена типа поверхности, например 'Создание Рощи'
- `Spell.GiveWards` - Наложение даров (вардов), например 'Благословение Имира' (Мотлин), 'Поспешность' (MNS)

---

### Типы зон (Zone)
Типы зон поддерживаемые генератором:
- `Zone.PlayerStart` - стартовая локация игрока. В центре зоны появится столица указанной расы. Первый рудник золота и источник родной маны будут под контролем расы.
- `Zone.Treasure` - сокровищница или обычная зона. В зоне будет создано множесто случайных проходы между объектами, выходами, а также ведущие в тупик.
- `Zone.Junction` - проходная, соединительная зона. Будет создан один проход соединяющий выходы.

---

### Типы таблиц
Таблицы указанные на английском в скобках доступны в утилитах `rsg.lua`.

---
#### Зона
Определяет зону на карте сценария.

Обязательные поля:
- `id` - идентификатор зоны. Число, уникально определяющее зону
- `type` - тип зоны. См. **Типы Зон**
- `size` - относительный размер зоны

В случае если в качестве типа зоны выбрана стартовая локация `type = Zone.PlayerStart` необходимо также указать уникальную расу для игрока в этой зоне:
- `race` - раса игрока. Одна из поданного в `getContents` списка рас или заранее заданная

Необязательные поля:
- `mines` - источники ресурсов в зоне. См. **Источники ресурсов**.
- `towns` - список нейтральных городов. См. **Город**.
- `ruins` - список руин. См. **Руины**.
- `merchants` - список торговцев. См. **Торговец**.
- `mages` - список башен магов. См. **Башня мага**.
- `mercenaries` - список лагерей наемников. См. **Лагерь наемников**.
- `trainers` - список тренировочных лагерей. См. **Тренер**.
- `stacks` - нейтральные отряды в зоне. См. **Нейтральные отряды**.
- `bags` - неохраняемые сундуки в зоне. См. **Неохраняемые сундуки**.

Примеры:
```lua
-- Стартовая зона с относительным размером 20.
-- Здесь будет столица первого игрока из списка рас.
-- В зоне будут созданы 1 золотой рудник и 1 источник маны рун.
{
    id = 0,
    type = Zone.PlayerStart,
    race = races[1],
    size = 20,
    
    mines = {
        gold = 1,
        runicMana = 1
    }
}
```
```lua
-- Обычная зона (сокровищница) с относительным размером 35.
-- В зоне будут случайно расположены 12 нейтральных отрядов общей ценностью 1200 - 1300.
{
    id = 3,
    type = Zone.Treasure,
    size = 35,
    
    stacks = {
        count = 12,
        value = { min = 1200, max = 1300 }
    }
}
```

---

#### Проход между 2 зонами
Определяет соединение двух зон, проход между ними.
Между двумя зонами может быть более одного прохода.

Обязательные поля:
- `from` - идентификатор первой зоны
- `to` - идентификатор второй зоны

Необязательные поля:
- `guard` - отряд охраняющий проход между зонами. См. **Группа / Отряд**.

Примеры:
```lua
-- Проход между зонами 0 и 1, без охраны
{ from = 0, to = 1 }
```
```lua
-- Проход между зонами 1 и 0, аналогичен предыдущему примеру
{ from = 1, to = 0 }
```
```lua
-- Проход между зонами 0 и 3.
-- Охраняется отрядом ценностью 1750 - 2250.
-- В инвентаре отряда будут созданы артефакты, знамена или перманентные зелья общей ценностью 2500 - 3000
{
    from = 0,
    to = 3,
    guard = {
        value = { min = 1750, max = 2250 },
        loot = {
            itemTypes = { Item.Weapon, Item.Armor, Item.Banner, Item.PotionPermanent },
            value = { min = 2500, max = 3000 }
        }
    }
}
```

---

#### Ценность (Value)
Задает ценность отряда, предмета или заклинания в диапазоне `[min : max]`.

Обязательные поля:
- `min` - минимальное значение ценности. Целое число.
- `max` - максимальное значение ценности. Целое число.

Примеры:
```lua
-- Ценность от 100 до 200
{ min = 100, max = 200 }
```
```lua
-- Ценность 175
{ min = 175, max = 175 }
```

---

#### Награда (Loot)
Описывает награду (лут). Награда может состоять из случайных и обязательных предметов.

Обязательных полей нет, пустая таблица создаст пустую награду.

Необязательные поля:
- `value` - ценность случайных предметов в награде. См. **Ценность**.
- `itemTypes` - список типов случайных предметов которые могут быть созданы. В случае пустого списка может быть создан предмет любого типа, кроме специального `Item.Special`.
- `items` - список предметов которые обязательно должны быть созданы. Не зависит от ценности награды. См. **Предмет награды**.

Примеры:
```lua
-- Случайная награда из зелий-бафов и воскрешения общей стоимостью от 500 до 750,
-- а также от 3 до 5 эликсиров восстановления
{
    itemTypes = { Item.PotionBoost, Item.PotionRevive },
    value = { min = 500, max = 750 },
    items = {
        { id = 'g000ig0006', min = 3, max = 5 }
    },
}
```
```lua
-- Награда из 5 зелий восстановления
{
    items = {
        { id = 'g000ig0006', min = 5, max = 5 }
    }
}
```
```lua
-- Случайная награда из знамен и сапог общей стоимостью от 2500 до 2750
{
    itemTypes = { Item.Banner, Item.TravelItem },
    value = { min = 2500, max = 2750 },
}
```

---

#### Предмет награды (Item)
Описывает обязательный предмет в награде.

Обязательные поля:
- `id` - идентификатор предмета из GItems.dbf
- `min` - минимальное число предметов
- `max` - максимальное число предметов

Пример:
```lua
-- От 1 до 5 эликсиров восстановления
{ id = 'g000ig0006', min = 1, max = 5 }
```

---

#### Группа / Отряд (Group)
Описывает группу юнитов в руинах или гарнизоне города, либо отряд с лидером.

Обязательные поля:
- `value` - общая ценность юнитов. См. **Ценность**.

Необязательные поля:
- `subraceTypes` - список сабрас определяющий какие типы юнитов могут быть созданы. См. **Субрасы**.
В случае пустого списка могут быть созданы юниты любых сабрас.
- `loot` - награда. См. **Награда**. В случае отряда награда создаст предметы инвентаря. Для группы в гарнизоне города награда создаст предметы в городе. **Важно:** награда группы внутри руин **не учитывается!**. Награда руин задается отдельно. См. **Руины**.

Пример:
```lua
-- Группа / Отряд из гномов или нейтральных людей.
-- В качестве награды будут созданы зелья лечения и бафов на 200 - 300 ценности.
{
    subraceTypes = { Subrace.Dwarf, Subrace.NeutralHuman },
    value = { min = 100, max = 150 },
    loot = {
        itemTypes = { Item.PotionHeal, Item.PotionBoost },
        value = { min = 200, max = 300 },
        items = {
            { id = 'g000ig0006', min = 1, max = 5 }
        }
    }
}
```

---

#### Город (Town)
Описывает нейтральный город, его гарнизон и посещающий отряд, а также предметы внутри города.

Обязательные поля:
- `tier` - уровень города в диапазоне `[1: 5]`

Необязательные поля:
- `garrison` - защитники в гарнизоне города. См. **Группа / Отряд**. **Важно:** Предметы указанные для защитников будут созданы в инвентаре города. 
- `stack` - отряд посещающий город. См. **Группа / Отряд**.

Пример:
```lua
-- Город 1 уровня с гарнизоном из гномов или нейтральных людей.
-- В гарнизоне будут созданы зелья лечения и бафов на 200 - 300 ценности.
-- Посещающий отряд в воротах города состоит из варваров и волков.
{
    tier = 1,
    garrison = {
        subraceTypes = { Subrace.Dwarf, Subrace.NeutralHuman },
        value = { min = 100, max = 150 },
        loot = {
            itemTypes = { Item.PotionHeal, Item.PotionBoost },
            value = { min = 200, max = 300 },
            items = {
                { id = 'g000ig0006', min = 1, max = 5 }
            }
        },
    },
    
    stack = {
        subraceTypes = { Subrace.NeutralBarbarian, Subrace.NeutralWolf },
        value = { min = 100, max = 150 },
        loot = {}
    }
}
```

---

#### Руины (Ruin)
Описывает руины, их защитников и награду.

Обязательные поля:
- `guard` - юниты внутри руин. **Важно:** предметы указанные для этой группы игнорируются!

Необязательные поля:
- `gold` - награда за руины в золоте. См. **Ценность**.
- `loot` - предмет-награда за руины. См. **Награда**. **Важно:** только один предмет из награды будет создан. Обязательные предметы имеют приоритет над случайными. В случае обязательных предметов будет выбран первый из списка.

Пример:
```lua
-- Руины с наградой из эликсира восстановления и 200 - 250 золота.
-- Охраняются группой защитников империи или нейтральных людей
{
    gold = { min = 200, max = 250 },
    loot = {
        items = {
            { id = 'g000ig0006', min = 1, max = 1 }
        },
    },
    
    guard = {
        subraceTypes = { Subrace.Human, Subrace.NeutralHuman },
        value = { min = 200, max = 250 }
    }
}
```

---

#### Торговец (Merchant)
Описывает лавку торговца, его товары и потенциальную охрану.

Обязательные поля:
- `goods` - ассортимент предметов торговца. См. **Награда**.

Необязательные поля:
- `guard` - отряд охраняющий вход в лавку торговца. См. **Группа / Отряд**.

Пример:
```lua
-- Торговец продающий оружие, броню, посохи и свитки на сумму от 1000 до 1500.
-- В ассортименте также от 1 до 5 эликсиров восстановления.
-- Охраняются отрядом защитников империи или нейтральных людей
{
    goods = {
        itemTypes = { Item.Weapon, Item.Armor, Item.Wand, Item.Scroll },
        value = { min = 1000, max = 1500 },
        items = {
            { id = 'g000ig0006', min = 1, max = 5 }
        },
    },
    
    guard = {
        subraceTypes = { Subrace.Human, Subrace.NeutralHuman },
        value = { min = 200, max = 250 }
    }
}
```

---

#### Башня мага (Mage)
Описывает башню мага, его заклинания и потенциальную охрану. Заклинания делятся на случайные и обязательные.

Обязательные поля:
- `value` - общая ценность случайных заклинаний. См. **Ценность**.

Необязательные поля:
- `spellTypes` - список типов случайных заклинаний которые могут появиться. См. **Типы заклинаний**. В случае пустого списка могут быть выбраны заклинания любых типов.
- `spells` - список идентификаторов заклинаний из GSpells.dbf которые обязательно появятся в башне мага. 
- `guard` - отряд охраняющий вход в башню мага. См. **Группа / Отряд**.

Пример:
```lua
-- Башня мага с заклинаниями лечения и ускорений общей ценностью от 200 до 1000.
-- В ассортименте обязательно появятся 'Быстрота' и 'Молния'.
{
    spellTypes = { Spell.Heal, Spell.RestoreMove },
    value = { min = 200, max = 1000 },
    spells = { 'g000ss0002', 'g000ss0004' },
}
```

---

#### Лагерь наемников (Mercenary)
Описывает лагерь наемников, юнитов в нем, а также потенциальную охрану. Юниты делятся на случайные и обязательные.

Обязательные поля:
- `value` - общая ценность случайных юнитов. См. **Ценность**.

Необязательные поля:
- `subraceTypes` - список сабрас определяющий какие типы юнитов могут быть созданы. См. **Субрасы**. В случае пустого списка могут быть созданы юниты любых сабрас.
- `units` - список наемников которые обязательно должны быть в лагере. Не зависит от ценности случайных юнитов. См. **Наемник**.
- `guard` - отряд охраняющий вход в лагерь. См. **Группа / Отряд**.

Пример:
```lua
-- Лагерь наемников с юнитами империи и нейтральными людьми общей ценностью от 200 до 250.
-- В лагере обязательно будут доступны 'Рейнджер' и 'Скелет-воин' 20 уровня, доступный для найма лишь единожды.
{
    subraceTypes = { Subrace.Human, Subrace.NeutralHuman },
    value = { min = 200, max = 250 },
    units = {
        { id = 'g000uu0007', level = 2, unique = false },
        { id = 'g000uu0088', level = 20, unique = true }
    }
}
```

---

#### Наемник (Unit)
Описывает обязательного наемника в лагере.

Обязательные поля:
- `id` - идентификатор юнита из GUnits.dbf
- `level` - уровень юнита. **Важно:** уровень юнита не может быть ниже базового!

Необязательные поля:
- `unique` - определяет будет ли юнит доступен для найма единожды

Пример:
```lua
-- 'Рейнджер' (т2 лучник империи), доступный для найма бесконечное число раз
{ id = 'g000uu0007', level = 2, unique = false }
```
```lua
-- 'Скелет-воин' (т3 воин нежити) 20 уровня, доступный для найма единожды
{ id = 'g000uu0088', level = 20, unique = true }
```

---

#### Тренер (Trainer)
Описывает тренировочный лагерь и его опциональную охрану.

Обязательных полей нет. Пустая таблица описывает тренировочный лагерь без охраны.

Необязательные поля:
- `guard` - отряд охраняющий вход в лагерь. См. **Группа / Отряд**.

Пример:
```lua
-- Тренировочный лагерь с отрядом охраны из людей и нейтральных людей общей ценностью 200 - 250.
{
    guard = {
        subraceTypes = { Subrace.Human, Subrace.NeutralHuman },
        value = { min = 200, max = 250 }
    }
}
```

---

#### Источники ресурсов
Описывает количество источников ресурсов каждого типа внутри зоны. В случае стартовых зон, первый источник золота и родной для игрока маны будут автоматически под владением игрока этой зоны.

Обязательных полей нет. Пустая таблица описывает зону без источников ресурсов.

Необязательные поля:
- `gold` - количество золотых шахт 
- `infernalMana` - количество источников маны преисподней
- `lifeMana` - количество источников маны жизни
- `deathMana` - количество источников маны смерти
- `runicMana` - количество источников маны рун
- `groveMana` - количество источников лесного эликсира

Пример:
```lua
-- Зона с 3 золотыми шахтами и 1 источником каждого вида маны
{
    gold = 3,
	runicMana = 1,
	lifeMana = 1,
	deathMana = 1,
	groveMana = 1,
	infernalMana = 1,
}
```

---

#### Нейтральные отряды
Описывает нейтральные отряды внутри зоны. Нейтральные отряды расположены случайным образом и могут блокировать проходы, а также доступ к некоторым объектам. Нейтральные отряды могут быть случайными и заранее заданными.

Обязательных полей нет. Пустая таблица описывает зону без нейтральных отрядов.

Необязательные поля:
- `value` - общая ценность случайных отрядов. Будет равномерно распределена по всем отрядам. См. **Ценность**.
- `count` - количество случайных отрядов в зоне
- `loot` - общая награда случайных отрядов. Будет равномерно распределена по всем отрядам. См. **Награда**. 
- `predefined` - список отрядов и их наград которые обязательно должны быть созданы в зоне, независит от количества случайных отрядов. См. **Группа / Отряд**.

Примеры:
```lua
-- 12 случайных отрядов общей ценностью 1200.
-- Награда из зелий лечения и буста общей ценностью 200 - 300.
-- На 12 отрядов обязательно будут созданы  1 - 5 эликсиров восстановления.
{
    count = 12,
    value = { min = 1200, max = 1200 },
    loot = {
		itemTypes = { Item.PotionHeal, Item.PotionBoost },
		value = { min = 200, max = 300 },
		items = {
			{ id = 'g000ig0006', min = 1, max = 5 }
		}
	}
}
```
```lua
-- 1 заранее заданный отряд ценностью 200 - 250 состоящий из юнитов империи или нейтральных людей
{
    predefined = {
        {
            subraceTypes = { Subrace.Human, Subrace.NeutralHuman },
			value = { min = 200, max = 250 }
        }
    }
}
```

---

#### Неохраняемые сундуки
Описывает неохраняемые сундуки внутри зоны.

Обязательных полей нет. Пустая таблица описывает зону без сундуков.

Необязательные поля:
- `loot` - общая награда всех сундуков. Будет равномерно распределена по всем сундукам. См. **Награда**. 
- `count` - количество сундуков в зоне

Пример:
```lua
-- 10 сундуков с зельями на буст и воскрешение общей суммой 5000 - 7500.
-- На 10 сундуков обязательно будут созданы 15 эликсиров восстановления.
{
    count = 10,
    loot = {
        itemTypes = { Item.PotionBoost, Item.PotionRevive },
        value = { min = 5000, max = 7500 },
        items = {
            { id = 'g000ig0005', min = 15, max = 15 },
        }
    },
}
```